{% extends 'base.html' %}
{% load rest_framework %}

{% block head %}
<title>Shipments - Hospital Administrator</title>
{% endblock %}

{% block content %}
<div class="card fixed fill">
  <h1 class="card-header bg-white">Shipments</h1>
  <div class="card-body">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
        <tr>
          <th>Shipment Status</th>
          <th>Shipped Quantity</th>
          <th>Ventilators</th>
          <th>Transition to Next State</th>
          <th>Call Back Reserve</th>
          <th>Deploy Reserve</th>
        </tr>
      </thead>
      <tbody>
        {% for shipment, show_edit in shipments %}
        <tr>
          <td>
            {% if shipment.status == 'Open' %}
            <span class="badge badge-primary">Open</span>
            {% elif shipment.status == 'Packed' %}
            <span class="badge badge-dark">Packed</span>
            {% elif shipment.status == 'Shipped' %}
            <span class="badge badge-warning">Shipped</span>
            {% elif shipment.status == 'Arrived' %}
            <span class="badge badge-info">Arrived</span>
            {% elif shipment.status == 'Accepted' %}
            <span class="badge badge-success">Accepted</span>
            {% elif shipment.status == 'RequestedReserve' %}
            <span class="badge badge-dark">RequestedReserve</span>
            {% elif shipment.status == 'Cancelled' %}
            <span class="badge badge-danger">Cancelled</span>
            {% elif shipment.status == 'Closed' %}
            <span class="badge badge-secondary">Closed</span>
            {% endif %}
          </td>
          <td>{{ shipment.shipped_qty }}</td>
          <td>
            <!-- <a href="#" class="btn btn-dark btn-sm">Ventilators</a> -->
            {% for shipment_ventilator in shipment.shipmentventilator_set.all %}
            <span class="model-number badge badge-pill badge-dark">{{shipment_ventilator.ventilator.ventilator_model.model}}</span>
            {% endfor %}
          </td>
          {% if show_edit %}
          <td>
              <button class="btn btn-dark mb-0" data-toggle="modal" data-target="#changeShipmentStatusModal" data-title="Change Shipment Status" data-method="PUT" data-action="{% url 'shipment-detail' shipment.id %}" data-status="{{ shipment.status }}">Change Shipment Status</button> 
          </td>
          {% else %}
          <td>Unable to Change Status</td>
          {% endif %}
          {% if show_reserve and shipment.status == 'Accepted' and shipment.is_requisition == False %}
            <td><a href="{% url 'call-back-reserve' shipment.id %}" class="btn btn-dark btn-sm">Call Back Reserve</a></td>
            <td><a href="{% url 'deploy-reserve' shipment.id %}" class="btn btn-dark btn-sm">Deploy Reserve</a></td>
          {% else %}
            <td>Unable to Call Back Reserve</td>
            <td>Unable to Deploy Reserve</td>
          {% endif %}
        </tr>
        {% endfor %}
        {% if shipments|length == 0 %}
        <tr>
          <td colspan="6">
            <div class="alert alert-info mb-0 text-center">
              No shipments to display
            </div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card-footer text-right bg-white">
    <button class="btn btn-dark mb-0" data-toggle="modal" data-target="#shipmentCreationModal">Create a New Shipment</button>
  </div>  
</div>

<div class="modal fade" id="shipmentCreationModal" tabindex="-1" role="dialog" aria-labelledby="shipmentCreationModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form method="POST" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"> Create a new Shipment</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <label for="num_requested">How large is your shipment</label>
        <input type="text" id="num_requested" class="form-control" name="num_requested">
        <br>
        <label for="ventilators">Select Ventilators</label>
        <select id="ventilators" class="form-control">
          <option value>------</option>
          {% for ventilator in ventilators %}
          <option value="{{ ventilator.id }}_{{ ventilator.serial_number }}_{{ ventilator.ventilator_model.model }}">{{ ventilator.serial_number }} ({{ ventilator.ventilator_model.model }})</option>
          {% endfor %}
        </select>

         <table id="tblVentilator" class="table table-bordered table-striped mt-3">
            <thead class="thead-dark">
              <tr>
                <th>Serial Number</th>
                <th>Model</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr class="d-none ventilator-row-template">
                <td class="serial-number"></td>
                <td class="model"></td>
                <td class="actions">
                  <button class="btn btn-dark btn-sm btn-cancel" type="button">
                    <i class="fa fa-times mr-1"></i>
                    Cancel
                  </button>
                </td>
              </tr>
              <tr class="no-ventilator">
                <td colspan="3">
                  <div class="alert alert-info mb-0 text-center">
                    No ventilators being selected
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-dark">Save</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="changeShipmentStatusModal" tabindex="-1" role="dialog" aria-labelledby="changeShipmentStatusModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="single-modal-form" action="" method="POST" class="modal-content">
      <input type="hidden" id="input-method" name="_method" value=""/>
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        {% render_form serializer %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-dark">Save</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block script %}
<script src="/static/js/hospital-admin/shipment.js"></script>
{% endblock %}
